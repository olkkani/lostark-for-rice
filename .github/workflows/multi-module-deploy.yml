name: multi-module-deploy.yml
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  IMAGE_NAME_PREFIX: "ghcr.io/${{ github.repository }}"
  BACK_DIR: "/home/${{ secrets.USERNAME }}/lfr/back"
  FRONT_DIR: "/home/${{ secrets.USERNAME }}/lfr/front"
  NGINX_DIR: "/home/${{ secrets.USERNAME }}/lfr/nginx"

jobs:
detect-changes:
  runs-on: ubuntu-24.04
  outputs:
    common-changed: ${{ steps.changes.outputs.common }}
    integration-service-changed: ${{ steps.changes.outputs.integration-service }}
    processor-service-changed: ${{ steps.changes.outputs.processor-service }}
    integration-deploy: ${{ steps.deploy-decision.outputs.integration-deploy }}
    processor-deploy: ${{ steps.deploy-decision.outputs.processor-deploy }}
  steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Detect changes
      uses: dorny/paths-filter@v3
      id: changes
      with:
        filters: |
          common:
            - 'common/**'
          integration-service:
            - 'integration-service/**'
          processor-service:
            - 'processor-service/**'

    - name: Decide what to deploy
      id: deploy-decision
      run: |
        # common이 변경되면 두 서비스 모두 배포
        if [ "${{ steps.changes.outputs.common }}" = "true" ]; then
          echo "integration-deploy=true" >> $GITHUB_OUTPUT
          echo "processor-deploy=true" >> $GITHUB_OUTPUT
        else
          echo "integration-deploy=${{ steps.changes.outputs.integration-service }}" >> $GITHUB_OUTPUT
          echo "processor-deploy=${{ steps.changes.outputs.processor-service }}" >> $GITHUB_OUTPUT
        fi

  build-integration:
    runs-on: ubuntu-24.04
    needs: detect-changes
    if: needs.detect-changes.outputs.integration-deploy == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Get short SHA
        run: echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build integration-service
        run: ./gradlew :integration-service:build

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.OLKK_GITHUB_TOKEN }}

      - name: Build and push integration-service Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./integration-service
          push: true
          tags: ${{ env.IMAGE_NAME_PREFIX }}/integration-service:${{ env.SHORT_SHA }}

  build-processor:
    runs-on: ubuntu-24.04
    needs: detect-changes
    if: needs.detect-changes.outputs.processor-deploy == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Get short SHA
        run: echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build processor-service
        run: ./gradlew :processor-service:build

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.OLKK_GITHUB_TOKEN }}

      - name: Build and push processor-service Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./processor-service
          push: true
          tags: ${{ env.IMAGE_NAME_PREFIX }}/processor-service:${{ env.SHORT_SHA }}

  serve-files:
    runs-on: ubuntu-24.04
    needs: [detect-changes, build-integration, build-processor]
    if: always() && (needs.detect-changes.outputs.integration-deploy == 'true' || needs.detect-changes.outputs.processor-deploy == 'true')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get short SHA
        run: echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Copy upstream conf files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          source: "./.github/nginx-config/upstream/"
          target: "${{ env.WORK_DIR }}"
          overwrite: true
          rm: true
          strip_components: 3

      - name: Copy docker-compose.yml to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          source: "./.github/docker-compose.yml"
          target: "${{ env.WORK_DIR }}"
          overwrite: true
          strip_components: 2

      - name: Setup environment variables
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            cd ${{ env.WORK_DIR }}
            
            # 기존 .env 파일 백업 및 초기화
            [ -f .env ] && cp .env .env.backup
            > .env
            
            # 공통 환경변수
            echo "DB_CONNECTION_URL=${{ secrets.DB_CONNECTION_URL }}" >> .env
            echo "DB_USER=${{ secrets.DB_USER }}" >> .env
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
            echo "AUCTION_API_KEY=${{ secrets.AUCTION_API_KEY }}" >> .env 
            echo "MARKET_API_KEY=${{ secrets.MARKET_API_KEY }}" >> .env 
            echo "DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}" >> .env
            echo "DB_REDIS_HOST=${{ secrets.DB_REDIS_HOST }}" >> .env
            echo "DB_REDIS_PORT=${{ secrets.DB_REDIS_PORT }}" >> .env
            echo "DB_REDIS_PASSWORD=${{ secrets.DB_REDIS_PASSWORD }}" >> .env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET}}" >> .env
            
            # 배포할 서비스의 이미지 태그 설정
            if [ "${{ needs.detect-changes.outputs.integration-deploy }}" = "true" ]; then
              echo "INTEGRATION_SERVICE_IMAGE=${{ env.IMAGE_NAME_PREFIX }}/integration-service:${{ env.SHORT_SHA }}" >> .env
            fi
            
            if [ "${{ needs.detect-changes.outputs.processor-deploy }}" = "true" ]; then
              echo "PROCESSOR_SERVICE_IMAGE=${{ env.IMAGE_NAME_PREFIX }}/processor-service:${{ env.SHORT_SHA }}" >> .env
            fi

  deploy-integration:
    runs-on: ubuntu-24.04
    needs: [detect-changes, serve-files]
    if: needs.detect-changes.outputs.integration-deploy == 'true'
    env:
      HOST: ${{ secrets.HOST }}
      PORT_BLUE: ${{ secrets.PORT_BLUE }}
      PORT_GREEN: ${{ secrets.PORT_GREEN }}
    steps:
      - name: Deploy integration-service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            COMPOSE_PATH="${{ env.WORK_DIR }}/docker-compose.yml"
            mkdir -p ${{ env.NGINX_DIR }}
            
            # 실행 중인 integration-service 확인
            ACTIVE_SERVICE=$(docker ps --format "{{.Names}}" | grep -E "integration-service-blue|integration-service-green" | head -n1)
            if [ "$ACTIVE_SERVICE" = "integration-service-blue" ]; then
              NEW_SERVICE="integration-service-green"
              OLD_SERVICE="integration-service-blue"
              mv "${{ env.WORK_DIR }}/upstream/integration-green.conf" "${{ env.NGINX_DIR }}/integration-active-upstream.conf"
            else
              NEW_SERVICE="integration-service-blue"
              OLD_SERVICE="integration-service-green"
              mv "${{ env.WORK_DIR }}/upstream/integration-blue.conf" "${{ env.NGINX_DIR }}/integration-active-upstream.conf"
            fi
            
            # 기존 서비스 종료
            docker compose -f "$COMPOSE_PATH" stop "$OLD_SERVICE" || true
            docker compose -f "$COMPOSE_PATH" rm -f "$OLD_SERVICE" || true
            
            # 새 서비스 실행
            docker compose -f "$COMPOSE_PATH" pull "$NEW_SERVICE"
            docker compose -f "$COMPOSE_PATH" up -d "$NEW_SERVICE"
            
            # Health check
            sleep 15 
            
            # Reload nginx config
            docker exec nginx nginx -s reload || true
            
            # 사용하지 않는 이미지 삭제
            docker image prune -f

  deploy-processor:
    runs-on: ubuntu-24.04
    needs: [detect-changes, serve-files]
    if: needs.detect-changes.outputs.processor-deploy == 'true'
    env:
      HOST: ${{ secrets.HOST }}
      PORT_BLUE: ${{ secrets.PORT_BLUE }}
      PORT_GREEN: ${{ secrets.PORT_GREEN }}
    steps:
      - name: Deploy processor-service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PRIVATE.HOST }}
          username: ${{ secrets.PRIVATE.USERNAME }}
          key: ${{ secrets.PRIVATE.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PRIVATE.PORT }}
          script: |
            COMPOSE_PATH="${{ env.WORK_DIR }}/docker-compose.yml"
            mkdir -p ${{ env.NGINX_DIR }}
            
            # 실행 중인 processor-service 확인
            ACTIVE_SERVICE=$(docker ps --format "{{.Names}}" | grep -E "processor-service-blue|processor-service-green" | head -n1)
            if [ "$ACTIVE_SERVICE" = "processor-service-blue" ]; then
              NEW_SERVICE="processor-service-green"
              OLD_SERVICE="processor-service-blue"
              mv "${{ env.WORK_DIR }}/upstream/processor-green.conf" "${{ env.NGINX_DIR }}/processor-active-upstream.conf"
            else
              NEW_SERVICE="processor-service-blue"
              OLD_SERVICE="processor-service-green"
              mv "${{ env.WORK_DIR }}/upstream/processor-blue.conf" "${{ env.NGINX_DIR }}/processor-active-upstream.conf"
            fi
            
            # 기존 서비스 종료
            docker compose -f "$COMPOSE_PATH" stop "$OLD_SERVICE" || true
            docker compose -f "$COMPOSE_PATH" rm -f "$OLD_SERVICE" || true
            
            # 새 서비스 실행
            docker compose -f "$COMPOSE_PATH" pull "$NEW_SERVICE"
            docker compose -f "$COMPOSE_PATH" up -d "$NEW_SERVICE"
            
            # Health check
            sleep 15 
            
            # Reload nginx config (processor용 설정이 있다면)
            docker exec nginx nginx -s reload || true
            
            # 사용하지 않는 이미지 삭제
            docker image prune -f

